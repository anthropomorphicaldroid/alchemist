<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alchemystic Game</title>
    <style>
      body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100%;
        height: 100%;
        position: fixed;
        background: #000;
        touch-action: none;
      }
      #unity-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #unity-canvas {
        width: 100vmin;
        height: 100vmin;
        max-width: 100%;
        max-height: 100%;
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas"></canvas>
    </div>
    
    <script src="Build/web.loader.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
      // Инициализация Telegram Web App
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableAutoResize = true;
      } else {
        console.warn("Telegram WebApp not detected. Running in standalone mode");
      }
      
      // Создаем конфиг Unity
      const config = {
        dataUrl: "Build/web.data",
        frameworkUrl: "Build/web.framework.js",
        codeUrl: "Build/web.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "AlchemysticGames",
        productName: "Alchemystic",
        productVersion: "0.21",
        devicePixelRatio: window.devicePixelRatio || 1,
        matchWebGLToCanvasSize: true
      };
      
      // Функция адаптации размера Canvas
      function resizeUnityCanvas() {
        const canvas = document.getElementById("unity-canvas");
        const container = document.getElementById("unity-container");
        
        // Получаем доступную высоту с учетом шапки Telegram
        const headerHeight = window.Telegram?.WebApp?.headerHeight || 40;
        const availableHeight = window.innerHeight - headerHeight;
        
        // Рассчитываем соотношение сторон
        const screenRatio = window.innerWidth / availableHeight;
        const gameRatio = 600 / 960; // Соотношение вашей игры 600x960
        
        // Вычисляем новые размеры
        let newWidth, newHeight;
        
        if (screenRatio > gameRatio) {
          // Широкий экран - ограничиваем по высоте
          newHeight = availableHeight;
          newWidth = availableHeight * gameRatio;
        } else {
          // Узкий экран - ограничиваем по ширине
          newWidth = window.innerWidth;
          newHeight = window.innerWidth / gameRatio;
        }
        
        // Устанавливаем размеры Canvas
        canvas.style.width = `${newWidth}px`;
        canvas.style.height = `${newHeight}px`;
        
        // Центрируем Canvas
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';
        
        console.log(`Canvas size: ${newWidth}x${newHeight}`);
      }
      
      // Создаем инстанс Unity
      function initializeUnity() {
        resizeUnityCanvas();
        
        createUnityInstance(document.querySelector("#unity-canvas"), config)
          .then(unityInstance => {
            console.log("Unity instance created");
            window.unityInstance = unityInstance;
            
            // Передаем информацию о пользователе в Unity
            if (window.Telegram?.WebApp) {
              const userData = {
                id: Telegram.WebApp.initDataUnsafe.user?.id,
                name: Telegram.WebApp.initDataUnsafe.user?.first_name
              };
              unityInstance.SendMessage('TelegramManager', 'SetUserData', JSON.stringify(userData));
            }
          })
          .catch(error => {
            console.error("Unity initialization failed:", error);
          });
      }
      
      // Запуск после полной загрузки
      window.addEventListener('load', initializeUnity);
      
      // Обработчики изменения размеров
      window.addEventListener('resize', resizeUnityCanvas);
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.onEvent('viewportChanged', resizeUnityCanvas);
      }
      
      // Функция для обновления размеров из Unity
      window.resizeGame = function(width, height) {
        const canvas = document.getElementById("unity-canvas");
        if (!canvas) return;
        
        canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;
        console.log(`Resized from Unity: ${width}x${height}`);
      };
    </script>
  </body>
</html>